<p align='center'>
<a href="https://oxygenpanda.github.io/" target="_blank"><img alt="Website" src="https://img.shields.io/badge/博客-劳振煜的知識倉儲-faf2f2.svg?style=flat-square&logo=Blogger"></a>
<a href="https://www.github.com/OXygenPanda" target="_blank"><img src="https://img.shields.io/badge/Github-@劳振煜-f3e1e1.svg?style=flat-square&logo=GitHub"></a>
<a href="https://i.loli.net/2020/11/11/SBZ2mFJGKLjUtTO.jpg" target="_blank"><img src="https://img.shields.io/badge/微信-@OXygen-f1d1d1.svg?style=flat-square&logo=WeChat"></a>


# 计算机网络 第三章

>   第三章的主要内容是 : 数据链路层

## 数据链路层基本概念及基本问题

### 基本概念

数据发送模型 :

-   主机1 - 电话网 - 路由器1 - 局域网 - 路由器2 - 广域网 - 路由器3 - 局域网 - 主机2.
-   在路由器上数据上升到网络层, 再进行转发.

数据链路层的信道类型 :

-   点对点信道
-   广播信道

链路与数据链路 :

-   链路 (link) 是一条点对点的物理线路段
-   数据链路 (data link) 除了物理线路外, 还必须有通信协议来控制这些数据的传输

帧 :

-   链路层传输的数据单元
-   获得网络层的数据报增加帧头和帧尾, 传递给物理层

### 三个基本问题

1.  封装成帧(一定要知道哪里开始哪里结束)

    封装成帧就是在一段数据的前后分别添加首部和尾部, 然后就构成一个帧, 确定帧的边界.

    首部和尾部的一个重要作用就是进行帧定界.

    帧的数据部分长度最大为1500字节.

    帧首部和帧尾部定界的作用 : 确保数据的完整性

2.  透明传输(数据中存在开始和结束的标识, 进行转变)

    在帧数据部分出现了SOH帧首部或EOT帧尾部内容, 会出现提前结束.

    解决方法 :

    -   发送端的数据链路层在数据中出现控制字符"SOH"或者"EOT"的前面插入转义字符"ESC"(十六进制编码为1B).
    -   字节填充或字符填充——接收端的数据链路层在将数据送往网络层之前删除插入的转义字符.
    -   如果转义字符也出现在数据中, 那么应该在转义字符前插入一个转义字符. 当接收端收到连续的两个转义字符时, 就删除前面一个.

3.  差错控制(检查帧的正确性)

    传输过程中可能会产生比特差错 : 1 可能会变成 0 , 0 可能会变成 1.

    在一段时间内, 传输错误的比特占所传输比特总数的比率称为误码率 BER (bit error rate).

    误码率与信噪比有很大的关系.

    为了保证数据传输的可靠性, 在计算机网络传输数据时, 必须采用各种差错检测措施.

    循环冗余检验 CRC :

    -   在数据链路层传送的帧中, 广泛使用了 CRC 的技术.
    -   在发送端, 先把数据划分为组. 假定每组为 k 个比特
    -   假设待传送的一组数据 M = 101001 (k = 6), 我们在 M 的后面再添加供差错检测用的 n 位冗余码一起发送.
    -   101001 - 000 (增加3位0, 要求除数是4位) / 1101 = 001 (FCS) , 把001加在101001后面, 组成 101001001 , 接收方除以相同的四位数 1101, 如果最终结果是 0 , 说明没有出错. 这个四位数 1101 或者更多位的数, 是链路层保证双方相同的.
    -   链路层的差错控制, 是无差错接收, 只接受没有比特差错的情况, 不需要重传.(重传是传输层的要求)

    帧检验序列 FCS :

    -   在数据后面添加上的冗余码称为帧检验序列 FCS.
    -   循环冗余检验 CRC 和帧检验序列 FCS 并不等同. (CRC 不是获得 FCS 的唯一途径)

## 两种情况下的数据链路层

### 使用点对点信道的数据链路层

**PPP协议( Pointer-to-Pointer Protocol)**

用户使用拨号电话线接入因特网的时候, 一般都是使用PPP协议. 具有拨号, 身份验证, 可以记账的特性.

**PPP协议应该满足的要求 :** 简单, 封装成帧, 透明性, 多层网络层协议, 多种类型链路, 差错检测, 检测连接状态, 最大传送单元, 网络层地址协商, 数据压缩协商.

**PPP协议不需要满足的要求 :** 纠错, 流量控制, 序号, 多点线路, 半双工或单工链路.

**PPP协议的组成 :**

-   数据链路层协议可以用于异步串行或同步串行介质.
-   它使用LCP(链路控制协议)建立并维护数据链路连接.
-   网络控制协议(NCP)允许在点到点连接上使用多种网络层协议.

|3. 上层协议 : IP IPX AppleTalk |

|2. 网络控制协议 NCP 针对每一个网络层协议 |

|2. 链路控制协议 LCP |

|2. 高级数据链路控制协议 HDLC |

|1. 物理层 |

**PPP协议帧格式 :**

首部 : | F{1} | A{1} | C{1} | 协议{2} | . 其中, A,C = FF,03 是固定的. 一般 首部和尾部的 : F(=7E)

-   协议{2} :
    -   0x0021 - PPP帧的信息字段就是IP数据报
    -   0xC021 - 信息字段是PPP链路控制数据
    -   0x8021 - 网络控制数据
    -   0xC023 - 安全性认证PAP
    -   0xC025 - LQR
    -   0xC223 - 安全性认证CHAP

数据部分 : IP数据报不超过1500字节.

尾部 : | FCS{2} | F{1} | . PPP协议的头尾的 F(=7E) 字段相同.

使用PPP协议以字节为单位还是以比特为单位发送数据时, 填充方案不相同, 具体如下 :

**字节填充 :**

-   信息字段出现标志字段的值的问题 : 信息字段的 0x7E 被拆分称为0x7D 0x5E, 信息字段的 0x7D 被拆分成0x7D 0x5D, ASCII 控制符(数值小于0x20)前加一个 0x7D 字节.(因此实际传输的信息可能是达不到1500字节)

**零比特填充方法 :**

-   避免出现和 0x7E 一样的比特序列, 0111,1110, 因此连续5个1补一个0
-   PPP协议用在SONET/SDH链路时, 是使用同步传输一连串的比特连续传送). 这时, PPP协议采用零比特填充方法来实现透明传输.
-   在发送端, 只要连续发现5个连续的1, 就立即填充一个0. 接收端扫描时, 5个连续的1后删除1个0.(可以用于避免0x7E的出现)

**PPP协议的工作状态 :**

-   当用户拨号接入ISP时, 路由器的调制解调器对拨号做出确认, 并建立一条物理连接.
-   PC机向路由器发送一系列的LCP分组(封装成多个PPP帧).
-   这些分组及其响应选择一些PPP参数, 和进行网络层配置, NCP给新接入的PC机分配一个临时的IP地址, 使PC机称为因特网上的一个主机.
-   通信完毕时, NCP释放网络层连接, 收回原来分配出去的IP地址. 接着, LCP释放数据链路层连接. 最后释放的是物理层连接.

### 使用广播信道的数据链路层

**补充知识 : 局域网的特定与优点**

局域网最主要的特点是 : 网络为一个单位所拥有, 且地理范围和结点数目均有限.

局域网具有如下的一些主要优点 :

-   具有广播功能, 从一个站点可以很方便地访问全网. 局域网上的主机可以共享连接在局域网上的各种硬件和软件资源.
-   便于系统的扩展和逐渐地演变, 各设备的位置可灵活调整和改变.
-   提高了系统的可靠性, 可用性和生存性.

**共享通信媒体**

静态划分信道 : 频分复用, 时分复用, 波分复用, 码分复用.

动态媒体接入控制(多点接入) : 随机接入(被以太网采用), 受控接入(已不被采用)

**认识以太网**

最初的以太网是将许多计算机都连接在一根总线上. 当初认为这样的链接方式既简单又可靠, 因为总线上没有有源器件. 问题是, 同时只有一个设备发送数据, 而且所有的设备都可以接收到数据包, 不够安全.

**以太网协议 :**

以太网使用的是CSMA/CD协议 (带冲突检测的多点接入技术)

多点接入 : 表示许多计算机以多点接入的方式连接在一根总线上

载波监听 : 是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据, 如果有, 则暂时不要发送数据, 以免碰撞.

*(P35 以太网的冲突检测暂时跳过)*

## 以太局域网

**以太网的两个标准 :**

1.  DIX Ethernet V2 是世界上第一个局域网产品(以太网)的规约.
2.  IEEE 的 802.3 标准.

**以太网与数据链路层的两个子层 :**

为了使数据链路层能更好地适应多种局域网标准, 802 委员会就将局域网的数据链路层拆成两个子层 :

1.  逻辑链路控制 LLC 子层
2.  媒体接入控制 MAC 子层

**以太网提供的服务 :**

以太网提供的服务是不可靠的交付, 即尽最大努力的交付.

当接收站收到有差错的数据帧时就丢弃此帧, 其他什么都不做. 差错的纠正由高层来决定.

如果高层发现丢弃一些数据而进行重传, 但以太网并不知道这是一个重传的帧, 而是当做一个新的数据帧来发送.

*(集线器部分暂时跳过)*

以太网的**信道利用率 :**

以太网的信道被占用的情况 :

争用期长度为 2tao , 即端到端传播时延的两倍. 检测到碰撞后不发送干扰信号.

帧长为 L (bit) , 数据发送速率为 C (b/s) , 因而帧的发送时间为 L/C = T0 (s)

信道利用率的最大值 : 各站发送数据都不发生碰撞的话, Smax = T0 / (T0 + tao)

**MAC层 :**

在局域网中, 硬件地址又称为物理地址, 或 MAC 地址.

MAC地址一共是48位二进制位, 其中高24位为厂家地址段, 低24位由厂家自行指派.

适配器检查MAC地址 :

适配器从网络上每收到一个MAC帧就首先用硬件检查MAC帧中的MAC地址 :

-   如果是发送往本站的帧则手下, 然后再进行其他的处理.
-   否则就将此帧丢弃, 不再进行其他的处理.

"发往本站的帧" 包括以下三种类型的帧 :

1.  单播帧 (一对一)
2.  广播帧 (一对全体) (MAC地址全1)
3.  多播帧 (一对多)

**以太网帧格式 :**

MAC帧 : | 目的地址{6} | 源地址{6} | 类型{2} | IP数据报{46 - 1500} | FCS{4} |  最短是64字节

物理层 : | 前同步码{7} | 帧开始定界符{1} | MAC帧 |

**无效的MAC帧 :**

-   帧的长度不是整数个字节;
-   用收到的帧检验序列 FCS 查出有差错;
-   数据字段的长度不在 46 ~ 1500 字节之间;
-   有效的MAC帧长度为 64 ~ 1518 字节之间;
-   对于检查出的无效的MAC帧就简单地丢弃. 以太网不负责重传丢弃的帧.

**帧间最小间隔 :**

帧间最小间隔为 9.6 us , 相当于 96 bit 的发送时间.

一个站在检测到总线开始空闲时, 还要等待 9.6 us 才能再次发送数据.

这样做是为了使刚刚收到的数据帧的站的接收缓存来得及清理, 做好接收下一帧的准备.

## 扩展以太网

集线器**扩展 :** 主机使用光纤和一对光纤调制解调器连接到集线器. 使用集线器连接最好低于30台机器, 冲突域变少, 冲突增大.

**网桥扩展 :** 在一个较小的冲突域里收发数据, 网桥不会转发到其他冲突域中, 可以减少冲突. 网桥有自学习算法并且建立转发表.

透明网桥使用了生成树算法 : 为了避免产生转发的帧在网络中不断地兜圈子.

**交换机(多接口的高速网桥)扩展 :** 安全, 效率高, 10M的交换机指的是每一个端口都是10M, 每一个端口都是全双工

交换机学习到的转发表格式 : | Vlan | Mac Address | Type | Ports |

### 虚拟局域网

**LAN和VLAN :**

交换机的使用使得VLAN的创建成为可能.

虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组.

-   这些网段具有某些共同的需求.
-   每一个 VLAN 的帧都有一个明确的标识符, 指明发送这个帧的工作站是属于哪一个 VLAN.

虚拟局域网其实只是局域网给用户提供的一种服务, 而不是一种新型局域网.

一个 VLAN = 一个广播域 = 逻辑网段(子网)

**ISL 标记(思科方式) :**

ISL 干道使 VLAN 能够跨骨干

-   通过特定集成电路来实现
-   不需要再客户计算机上采取配置, 客户机不能够看到ISL头
-   在交换机之间, 路由器和交换机, 交换机和支持ISL网卡的服务器之间配置

ISL 封装 : | DA | Type | User | SA | LEN | AAAA03 | HSA | VLAN | BPDU | INDEX | RES | 以太网帧 | CRC |

**虚拟局域网帧格式 :**

虚拟局域网协议允许在以太网的帧格式中插入一个4字节的标识符, 称为 VLAN 标记 (tag) , 用来指明发送该帧的工作站属于哪一个虚拟局域网.

格式 : | 目的地址{6} | 源地址{6} | VLAN标记{4} | 类型{2} | 数据{46 ~ 1500} | FCS{4} |

## 高速以太网

速率达到或超过 100 Mb/s 的以太网称为高速以太网.

**100BASE-T 以太网 :** 可以全双工方式下工作而无冲突发生. 因此, 不使用 CSMA/CD 协议. MAC帧格式仍然是 802.3 标准规定的. 帧间时间间隔从 9.6 us 变成了 0.96 us.

**吉比特以太网 :** 允许在1 Gb/s 下全双工和半双工两种方式工作. 使用 802.3 协议规定的帧格式. 在半双工方式下使用 CSMA/CD 协议, 全双工不需要. 与 10BASE-T 和 100BASE-T 技术向后兼容.

**10吉比特以太网 :** 以太网的工作范围已经从局域网(校园网, 企业网)扩大到城域网和广域网, 从而实现了端到端的以太网传输. 这种工作方式的好处是 : 成熟的技术, 互操作性好, 在广域网中使用以太网时价格便宜, 统一的帧格式简化了操作和管理.

### Cisco建网3层模型

普通的交换机 : 连接计算机, 需要接口数量多

汇聚层交换机 : 连接普通的交换机, 一般单位是整栋楼

核心层交换机 : 连接汇聚层交换机, 一般单位是一个一个区域

### 交换机安全

交换机可以设置某一个端口只能和指定的MAC地址的主机交换数据, 保证链路层安全. 也可以设置某个端口只能连接一台计算机. 否则, 关闭端口.