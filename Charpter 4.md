<p align='center'>
<a href="https://oxygenpanda.github.io/" target="_blank"><img alt="Website" src="https://img.shields.io/badge/博客-劳振煜的知識倉儲-faf2f2.svg?style=flat-square&logo=Blogger"></a>
<a href="https://www.github.com/OXygenPanda" target="_blank"><img src="https://img.shields.io/badge/Github-@劳振煜-f3e1e1.svg?style=flat-square&logo=GitHub"></a>
<a href="https://i.loli.net/2020/11/11/SBZ2mFJGKLjUtTO.jpg" target="_blank"><img src="https://img.shields.io/badge/微信-@OXygen-f1d1d1.svg?style=flat-square&logo=WeChat"></a>


# 计算机网络 第四章

>   第四章的主要内容是 : 网络层

## 网络层提供的两种服务

网络层关注的是如何将分组从源端沿着网络路径送达目的端.

两种服务 :

1.  虚电路服务
2.  数据报服务

### 虚电路(专线,固定. 不需要写IP地址)

虚电路表示这是一条逻辑上的连接, 分组都沿着这条逻辑连接按照存储转发方式传送, 而并不是真正建立了一条物理连接. 电路交换的电话通信是先建立一条真正的连接. 因此分组交换的虚连接和电路交换的连接只是类似, 并不完全一样.

### 数据报(灵活,低耦合. 需要写IP地址)

网络层向上只提供简单灵活的, 无连接的, 尽最大努力交付的数据报服务. 网络在发送分组时不需要先建立连接. 每一个分组(IP数据报)独立发送, 与其前后的分组无关. 网络层不提供服务质量的承诺. 即所传送的分组可能出错, 丢失, 重复和失序, 当然也不保证分组传送的时限.

尽最大努力交付的好处 :

-   由于传输网络不提供端到端的可靠传输服务, 这就使网络中的路由器可以做的比较简单, 而且价格低廉.
-   如果主机中的进程通信需要是可靠的, 那么就由网络的主机中的运输层负责(包括差错处理, 流量控制等).
-   采用这种设计思路的好处是 : 网络的造价大大降低, 运行方式灵活, 能够适应多种应用.
-   因特网能够发展到今日的规模, 充分证明了当初采用这种设计思路的正确性.

### 虚电路服务和数据报服务的比较

**虚电路**

思路 : 可靠通信应当由网络来保证

连接的建立 : 必须有

终点地址 : 仅在连接建立阶段使用, 每个分组使用短的虚电路号

分组的转发 : 属于同一条虚电路的分组均按照同一路由进行转发

当结点出故障时 : 所有通过出故障的结点的虚电路均不能工作

分组的顺序 : 总是按发送顺序到达终点

端到端的差错处理和流量控制 : 可以由网络负责, 也可以由用户主机负责

**数据报**

思路 : 可靠通信应当由用户主机来保证

连接的建立 : 不需要

终点地址 : 每个分组都有终点的完整地址

分组的转发 : 每个分组独立选择路由进行转发

当结点出故障时 : 由故障的结点可能会丢失分组, 一些路由可能会发生变化

分组的顺序 : 到达终点时不一定按发送顺序

端到端的差错处理和流量控制 : 由用户主机负责

## 网际协议 IP

### 虚拟互联网

**网络互连的设备**

中间设备又称为中间系统或者中继系统.

-   物理层中继系统 : 转发器 或者 集线器
-   数据链路层中继系统 : 网桥 或者 交换机
-   网络层中继系统 : 路由器
-   网络层以上的中继系统 : 网关

当中继系统是集线器或网桥时, 一般不称为网络互连, 因为这仅仅是把一个网络扩大了, 而这仍然是一个网络.

网关由于比较复杂, 目前使用的较少.

互联网都是指用路由器进行互连的网络.

由于历史原因, 许多有关 TCP/IP 的文献将网络层使用的路由器称为网关.

**网络互联的问题**

互联在一起的网络要进行通信, 会遇到许多问题需要解决, 如 : 不同的寻址方案, 不同的最大分组长度, 不同的网络接入机制, 不同的超时控制, 不同的差错恢复方法, 不同的状态报告方法, 不同的路由选择技术, 不同的用户接入控制, 不同的服务, 不同的管理与控制方式.

**IP协议简介**

网际协议IP 是 TCP/IP 体系中两个最主要的协议之一. 与 IP协议配合使用的还有四个协议 :

1.  地址解析协议 ARP *(Address Resolution Protocol)*
2.  逆地址解析协议 RARP *(Reserve Address Resolution Protocol)*
3.  网际控制报文协议 ICMP *(Internet Control Message Protocol)*
4.  网际组管理协议 IGMP *(Internet Group Management Protocol)*

### IP地址

**IP层次结构**

层次化IP地址 : 层次化IP地址将32位的IP地址分为网络ID和主机ID

**网络地址**

网络地址唯一指定了每一个网络. 同一网络中的每台计算机都共享相同的网络地址, 并用它作为自己IP地址的一部分.

A类地址 : 8位网络号 (net-id : 0.......)

-   最大网络数 126 第一个可用的网络号 1 最后一个可用的网络号 127 每个网络的最大主机数 16777214

B类地址 : 16位网络号(net-id : 10...... ........)

-   最大网络数 16383 第一个可用的网络号 128.1 最后一个可用的网络号 191.255 每个网络的最大主机数 65534

C类地址 : 24位网络号(net-id : 110..... ........ .........)

-   最大网络数 2097151 第一个可用的网络号 192.0.1 最后一个可用的网络号 223.255.255 每个网络的最大主机数 254

D类地址 : 组播 (1110 28.)

E类地址 : 研究 (1111 28.)

特殊的几个地址 : ****

127.0.0.1 本地回环地址

169.254.0.0 无法自动分配地址时,分配这个网段

保留的私网地址 10.0.0.0, 172.16.0.0 - 172.31.0.0, 192.168.0.0 - 192.168.255.0

**子网掩码**

子网掩码的作用是确定IP地址的网络号的位数.

### 划分子网和构造超网

**划分子网**

划分子网可以让一个网络号继续拆分出多个子网, 使得使用更加地充分.

比如, 一个C类地址的网络号是24位, 可以容纳254台主机, 可以进一步使用第25位主机号用于子网络号, 拆分126台和126台主机的两个子网.同时, 子网掩码也要往后移动一位.

划分四个子网时, 取2位作为子网络号, 因此可以用的主机号范围是 :

A: (0网络) 1 - 62 (63广播)

B: 65 - 126

C: 129 - 190

D: 192 - 254

网关是主机号为1的IP地址, 是路由器的出口IP地址.

广播是主机号为最大的IP地址.

最小划分到, 网络号为24位,子网络号为6位,主机号为2位: 00网络,01网关,02主机,03广播.

**构造超网**

将网络号左移若干位, 可以构造超网.

### IP地址与硬件地址

使用IP地址通信, 而不是直接使用MAC地址通信, 是因为, IP地址可以确定源地址和目标地址, 而MAC地址在每一次转发的时候都需要改变. 除非没有网络层设备, 所有主机全部使用超大的交换机相连, 每一次广播都可以得知目标MAC地址的主机进行转发.

**ARP协议**

IP地址 → ARP → MAC地址

ARP欺骗: 在同一个网段里的计算机在需要知道一个IP地址的MAC地址时,会进行广播, 这个时候本应只有网关会回复你, 但是有其他主机告诉你MAC地址的话, 你就会受到ARP欺骗, 他把他自己作为"网关", 可以控制每一个主机的带宽.

**RARP协议**

MAC地址 → RARP → IP地址(地址请求的过程)

### IP数据报格式

首部{20} | 数据部分

首部{20} :

| 版本{4b} | 首部长度{4b} | 区分服务{1} | 总长度{2} |

| 标识{2} | 标志{3b} | 片偏移{29b} |

| 生存时间{1} | 协议{1} | 首部检验和{2} |

| 源地址{4} |

| 目的地址{4} |

可变部分 : | 可选字段 | 填充至4字节的整数倍 |

| 数据部分 |

版本 : 4位,指定IP协议版本(IPv4, IPv6)

首部长度 : 4位,除数据部分以外的首部有多长(4位能够表示0-15,一个数代表4个字节,因此最大值为60字节)

区分服务 : 8位,只有使用区分服务,该字段才起作用.

总长度 : 16位,首部和数据之和的长度.(因此最大值为65535字节,不能超过最大传送单元MTU)

标识 : 16位,计数器,用来产生数据报的标识,不是序号,每产生一个数据包+1

标志 : 3位,目前只有前两位有意义,标志字段的最低位是MF.MF=1标识后面还有分片,MF=0标识后面没有分片.标识字段中间位是DF,只有DF=0才允许分片.

片偏移 : 13位,较长的分组在分片后,某片在原分组中的相对位置,片偏移以8个字节为偏移单位.比如1400/8 = 175

生存时间 : 8位,记为TTL,经过路由器的C++最大跳数

协议 : 8位,标记数据报携带的数据使用的协议

首部校验和 : 16位,用于检错,反码算术运算求和

可变部分 : 支持排错,测量以及安全等措施,1字节-40字节,很少被用到.

### IP转发分组的流程

数据路由: 路由器在不同网段转发数据报

网络畅通的条件: 能去能回,沿途的路由器都必须知道到源地址和目标地址网络下一跳给哪个接口

## 网际控制报文协议 ICMP

## 因特网的路由选择协议

## IP 多播

## 虚拟专用网 VPN 和网络地址转换 NAT